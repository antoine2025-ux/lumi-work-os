generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model User {
  id                      String                 @id @default(cuid())
  name                    String?
  email                   String                 @unique
  emailVerified           DateTime?
  image                   String?
  createdAt               DateTime               @default(now())
  updatedAt               DateTime               @updatedAt
  themePreference         String?                @default("default")
  bio                     String?
  skills                  String[]               @default([])
  currentGoals            String[]               @default([])
  interests               String[]               @default([])
  timezone                String?
  location                String?
  phone                   String?
  linkedinUrl             String?
  githubUrl               String?
  personalWebsite         String?
  accounts                Account[]
  activities              Activity[]
  chatSessions            ChatSession[]
  onboarding_plans        OnboardingPlan[]
  orgAuditLogs            OrgAuditLog[]
  orgPositions            OrgPosition[]
  projectAssignees        ProjectAssignee[]      @relation("ProjectAssignee")
  projectMemberships      ProjectMember[]
  projectSpaceMemberships ProjectSpaceMember[]
  projectTemplates        ProjectTemplate[]
  projectWatchers         ProjectWatcher[]       @relation("ProjectWatcher")
  createdProjects         Project[]
  ownedProjects           Project[]              @relation("ProjectOwner")
  roleCards               RoleCard[]
  sessions                Session[]
  assignedSubtasks        Subtask[]
  taskComments            TaskComment[]
  taskHistory             TaskHistory[]
  createdTaskTemplates    TaskTemplate[]         @relation("TaskTemplateCreator")
  assignedTasks           Task[]                 @relation("TaskAssignee")
  createdTasks            Task[]                 @relation("TaskCreator")
  wiki_ai_interactions    wiki_ai_interactions[]
  wikiComments            WikiComment[]
  wiki_favorites          WikiFavorite[]
  wikiPagePermissions     WikiPagePermission[]
  wiki_page_views         wiki_page_views[]
  wikiPages               WikiPage[]
  wikiVersions            WikiVersion[]
  wiki_workspaces         wiki_workspaces[]
  workflowAssignments     WorkflowAssignment[]
  workflowInstances       WorkflowInstance[]
  createdInvites          WorkspaceInvite[]      @relation("InviteCreator")
  workspaceMemberships    WorkspaceMember[]
  ownedWorkspaces         Workspace[]            @relation("WorkspaceOwner")
  onboarding_tasks        OnboardingTask[]       @relation("OnboardingTaskToUser")

  @@map("users")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Workspace {
  id                  String               @id @default(cuid())
  name                String
  slug                String               @unique
  description         String?
  logo                String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  ownerId             String
  chatSessions        ChatSession[]
  featureFlags        FeatureFlag[]
  integrations        Integration[]
  migrations          Migration[]
  onboardingPlans     OnboardingPlan[]
  onboardingTemplates OnboardingTemplate[]
  orgAuditLogs        OrgAuditLog[]
  orgDepartments      OrgDepartment[]
  orgPositions        OrgPosition[]
  orgTeams            OrgTeam[]
  projectTemplates    ProjectTemplate[]
  projects            Project[]
  projectSpaces       ProjectSpace[]
  roleCards           RoleCard[]
  taskTemplates       TaskTemplate[]
  tasks               Task[]
  wikiChunks          WikiChunk[]
  wikiPages           WikiPage[]
  wiki_workspaces     wiki_workspaces[]
  workflowInstances   WorkflowInstance[]
  workflows           Workflow[]
  invites             WorkspaceInvite[]
  members             WorkspaceMember[]
  owner               User                 @relation("WorkspaceOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  @@map("workspaces")
}

model WorkspaceMember {
  id          String        @id @default(cuid())
  workspaceId String
  userId      String
  role        WorkspaceRole @default(MEMBER)
  joinedAt    DateTime      @default(now())
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace   Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([userId], map: "idx_workspace_members_user")
  @@index([userId, workspaceId], map: "idx_workspace_members_user_workspace")
  @@map("workspace_members")
}

model WorkspaceInvite {
  id               String           @id @default(cuid())
  workspaceId      String
  email            String           @db.VarChar(255)
  role             WorkspaceRole    @default(MEMBER)
  token            String           @unique
  expiresAt        DateTime
  acceptedAt       DateTime?
  revokedAt        DateTime?
  createdAt        DateTime         @default(now())
  createdByUserId  String
  positionId       String?
  viewerScopeType  ViewerScopeType?
  viewerScopeRefId String?
  createdByRole    WorkspaceRole
  createdBy        User             @relation("InviteCreator", fields: [createdByUserId], references: [id], onDelete: Cascade)
  workspace        Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  position         OrgPosition?     @relation(fields: [positionId], references: [id], onDelete: SetNull)

  @@index([workspaceId, email], map: "idx_invites_workspace_email")
  @@index([workspaceId, revokedAt, acceptedAt], map: "idx_invites_workspace_status")
  @@index([token], map: "idx_invites_token")
  @@index([positionId], map: "idx_invites_position")
  @@index([workspaceId, email, revokedAt, acceptedAt, expiresAt], map: "idx_invites_pending_lookup")
  @@index([workspaceId, positionId], map: "idx_invites_workspace_position")
  @@map("workspace_invites")
}

model WikiPage {
  id                   String                 @id @default(cuid())
  workspaceId          String
  title                String
  slug                 String
  content              String
  excerpt              String?
  parentId             String?
  order                Int                    @default(0)
  isPublished          Boolean                @default(true)
  tags                 String[]
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  createdById          String
  permissionLevel      String                 @default("team")
  category             String                 @default("general")
  view_count           Int?                   @default(0)
  is_featured          Boolean?               @default(false)
  workspace_type       String?                @default("team") @db.VarChar(50)
  last_viewed_at       DateTime?              @db.Timestamp(6)
  ai_analysis          Json?
  quality_score        Decimal?               @db.Decimal(3, 2)
  projectLinks         ProjectDocumentation[]
  projects             Project[]              @relation("ProjectPrimaryWiki")
  wiki_ai_interactions wiki_ai_interactions[]
  attachments          WikiAttachment[]
  chunks               WikiChunk[]
  comments             WikiComment[]
  embeds               WikiEmbed[]
  wiki_favorites       WikiFavorite[]
  permissions          WikiPagePermission[]
  wiki_page_views      wiki_page_views[]
  createdBy            User                   @relation(fields: [createdById], references: [id], onDelete: Cascade)
  parent               WikiPage?              @relation("WikiPageHierarchy", fields: [parentId], references: [id])
  children             WikiPage[]             @relation("WikiPageHierarchy")
  workspace            Workspace              @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  versions             WikiVersion[]

  @@unique([workspaceId, slug])
  @@index([last_viewed_at(sort: Desc)], map: "idx_wiki_pages_last_viewed")
  @@index([tags], map: "idx_wiki_pages_tags", type: Gin)
  @@index([view_count(sort: Desc)], map: "idx_wiki_pages_view_count")
  @@index([workspace_type], map: "idx_wiki_pages_workspace_type")
  @@index([workspaceId, updatedAt], map: "idx_wiki_pages_workspace_updated")
  @@index([workspaceId, isPublished], map: "idx_wiki_pages_workspace_published")
  @@index([workspaceId, workspace_type], map: "idx_wiki_pages_workspace_type_alt")
  @@index([updatedAt(sort: Desc)], map: "idx_wiki_pages_updated_at")
  @@map("wiki_pages")
}

model WikiFavorite {
  id         String    @id @default(cuid()) @db.VarChar(50)
  page_id    String    @db.VarChar(50)
  user_id    String    @db.VarChar(50)
  created_at DateTime? @default(now()) @db.Timestamp(6)
  wiki_pages WikiPage  @relation(fields: [page_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users      User      @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([page_id, user_id])
  @@index([page_id], map: "idx_wiki_favorites_page_id")
  @@index([user_id], map: "idx_wiki_favorites_user_id")
  @@index([user_id, page_id], map: "idx_wiki_favorites_user_workspace")
  @@map("wiki_favorites")
}

model WikiAttachment {
  id        String   @id @default(cuid())
  pageId    String
  fileName  String
  fileSize  Int
  fileType  String
  fileUrl   String
  createdAt DateTime @default(now())
  page      WikiPage @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@map("wiki_attachments")
}

model WikiComment {
  id        String   @id @default(cuid())
  pageId    String
  userId    String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  page      WikiPage @relation(fields: [pageId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([pageId, createdAt(sort: Desc)], map: "idx_wiki_comments_page_created")
  @@map("wiki_comments")
}

model WikiVersion {
  id          String   @id @default(cuid())
  pageId      String
  content     String
  version     Int
  createdAt   DateTime @default(now())
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id], onDelete: Cascade)
  page        WikiPage @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@index([pageId, version], map: "idx_wiki_versions_page_version")
  @@map("wiki_versions")
}

model WikiChunk {
  id          String    @id @default(cuid())
  pageId      String
  workspaceId String
  content     String
  metadata    Json?
  createdAt   DateTime  @default(now())
  page        WikiPage  @relation(fields: [pageId], references: [id], onDelete: Cascade)
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@map("wiki_chunks")
}

model WikiPagePermission {
  id         String         @id @default(cuid())
  pageId     String
  userId     String?
  role       WorkspaceRole?
  permission String
  granted    Boolean        @default(true)
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  page       WikiPage       @relation(fields: [pageId], references: [id], onDelete: Cascade)
  user       User?          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([pageId, userId, permission])
  @@index([pageId, userId], map: "idx_wiki_page_permissions_page_user")
  @@map("wiki_page_permissions")
}

model WikiEmbed {
  id          String   @id @default(cuid())
  pageId      String
  provider    String
  url         String?
  resourceId  String?
  title       String?
  description String?
  thumbnail   String?
  metadata    Json?
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  page        WikiPage @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@map("wiki_embeds")
}

model OnboardingTemplate {
  id               String           @id @default(cuid())
  workspaceId      String
  name             String
  description      String?
  role             String?
  duration         Int
  isActive         Boolean          @default(true)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  plans            OnboardingPlan[]
  onboarding_tasks OnboardingTask[]
  workspace        Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@map("onboarding_templates")
}

model OnboardingTask {
  id                          String                        @id @default(cuid())
  templateId                  String
  title                       String
  description                 String?
  order                       Int
  isRequired                  Boolean                       @default(true)
  estimatedMinutes            Int?
  createdAt                   DateTime                      @default(now())
  updatedAt                   DateTime
  onboarding_task_assignments onboarding_task_assignments[]
  onboarding_templates        OnboardingTemplate            @relation(fields: [templateId], references: [id], onDelete: Cascade)
  users                       User[]                        @relation("OnboardingTaskToUser")

  @@map("onboarding_tasks")
}

model OnboardingPlan {
  id                          String                        @id @default(cuid())
  workspaceId                 String
  templateId                  String?
  userId                      String
  title                       String
  status                      OnboardingStatus              @default(ACTIVE)
  startDate                   DateTime
  endDate                     DateTime?
  createdAt                   DateTime                      @default(now())
  updatedAt                   DateTime                      @updatedAt
  template                    OnboardingTemplate?           @relation(fields: [templateId], references: [id])
  users                       User                          @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace                   Workspace                     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  onboarding_task_assignments onboarding_task_assignments[]

  @@index([userId, status], map: "idx_onboarding_plans_employee_status")
  @@map("onboarding_plans")
}

model OrgDepartment {
  id          String    @id @default(cuid())
  workspaceId String
  name        String
  description String?
  color       String?
  order       Int       @default(0)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  teams       OrgTeam[]

  @@unique([workspaceId, name])
  @@index([workspaceId])
  @@map("org_departments")
}

model OrgTeam {
  id           String        @id @default(cuid())
  workspaceId  String
  departmentId String
  name         String
  description  String?
  color        String?
  order        Int           @default(0)
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  positions    OrgPosition[]
  department   OrgDepartment @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  workspace    Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, departmentId, name])
  @@index([workspaceId])
  @@index([departmentId])
  @@map("org_teams")
}

model RoleCard {
  id               String       @id @default(cuid())
  workspaceId      String
  roleName         String
  jobFamily        String
  level            String
  roleDescription  String
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  createdById      String
  keyMetrics       String[]     @default([])
  positionId       String?      @unique
  preferredSkills  String[]     @default([])
  requiredSkills   String[]     @default([])
  responsibilities String[]     @default([])
  createdBy        User         @relation(fields: [createdById], references: [id], onDelete: Cascade)
  position         OrgPosition? @relation(fields: [positionId], references: [id])
  workspace        Workspace    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([positionId])
  @@index([jobFamily])
  @@index([level])
  @@map("role_cards")
}

model OrgPosition {
  id                 String            @id @default(cuid())
  workspaceId        String
  userId             String?
  title              String
  level              Int               @default(1)
  parentId           String?
  order              Int               @default(0)
  isActive           Boolean           @default(true)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  roleDescription    String?
  responsibilities   String[]          @default([])
  requiredSkills     String[]          @default([])
  preferredSkills    String[]          @default([])
  keyMetrics         String[]          @default([])
  teamSize           Int?
  budget             String?
  reportingStructure String?
  teamId             String?
  parent             OrgPosition?      @relation("OrgHierarchy", fields: [parentId], references: [id])
  children           OrgPosition[]     @relation("OrgHierarchy")
  team               OrgTeam?          @relation(fields: [teamId], references: [id])
  user               User?             @relation(fields: [userId], references: [id])
  workspace          Workspace         @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  roleCard           RoleCard?
  invites            WorkspaceInvite[]

  @@index([workspaceId])
  @@index([workspaceId, isActive], map: "idx_org_positions_workspace_active")
  @@index([teamId])
  @@index([level])
  @@index([parentId], map: "idx_org_positions_parent_id")
  @@map("org_positions")
}

model OrgAuditLog {
  id          String    @id @default(cuid())
  workspaceId String
  userId      String
  action      String
  entityType  String
  entityId    String
  oldValues   Json?
  newValues   Json?
  metadata    Json?
  createdAt   DateTime  @default(now())
  user        User      @relation(fields: [userId], references: [id])
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@map("org_audit_log")
}

model Workflow {
  id          String             @id @default(cuid())
  workspaceId String
  name        String
  description String?
  definition  Json
  isActive    Boolean            @default(true)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  instances   WorkflowInstance[]
  workspace   Workspace          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@map("workflows")
}

model WorkflowInstance {
  id          String               @id @default(cuid())
  workflowId  String
  workspaceId String
  userId      String
  status      WorkflowStatus       @default(PENDING)
  data        Json?
  startedAt   DateTime             @default(now())
  completedAt DateTime?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  assignments WorkflowAssignment[]
  user        User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  workflow    Workflow             @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  workspace   Workspace            @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId, status], map: "idx_workflow_instances_workspace_status")
  @@map("workflow_instances")
}

model WorkflowAssignment {
  id          String           @id @default(cuid())
  instanceId  String
  userId      String
  stepName    String
  status      AssignmentStatus @default(PENDING)
  data        Json?
  assignedAt  DateTime         @default(now())
  completedAt DateTime?
  instance    WorkflowInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("workflow_assignments")
}

model Integration {
  id          String          @id @default(cuid())
  workspaceId String
  type        IntegrationType
  name        String
  config      Json
  isActive    Boolean         @default(false)
  lastSyncAt  DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  workspace   Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId, type], map: "idx_integrations_workspace_type")
  @@map("integrations")
}

model Migration {
  id             String          @id @default(cuid())
  workspaceId    String
  sourcePlatform String
  status         MigrationStatus @default(PENDING)
  progress       Json
  config         Json
  result         Json?
  startedAt      DateTime        @default(now())
  completedAt    DateTime?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  workspace      Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId, status], map: "idx_migrations_workspace_status")
  @@map("migrations")
}

model ChatSession {
  id               String        @id @default(cuid())
  workspaceId      String
  userId           String
  title            String
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  draftBody        String?
  draftFormat      String        @default("markdown")
  draftTitle       String?
  intent           String        @default("assist")
  pageSettings     Json?
  phase            String        @default("idle")
  requirementNotes Json?
  target           String        @default("wiki_page")
  wikiUrl          String?
  projectUrl       String?
  model            String?       @default("gpt-4-turbo")
  messages         ChatMessage[]
  user             User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace        Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([userId, workspaceId], map: "idx_chat_sessions_user_workspace")
  @@index([workspaceId, userId, phase], map: "idx_chat_sessions_workspace_user_draft")
  @@index([updatedAt(sort: Desc)], map: "idx_chat_sessions_updated_at")
  @@map("chat_sessions")
}

model ChatMessage {
  id        String      @id @default(cuid())
  sessionId String
  type      MessageType
  content   String
  metadata  Json?
  createdAt DateTime    @default(now())
  session   ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt], map: "idx_chat_messages_session_created")
  @@map("chat_messages")
}

model ProjectSpace {
  id          String                 @id @default(cuid())
  workspaceId String
  name        String
  description String?
  visibility  ProjectSpaceVisibility @default(PUBLIC)
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt
  workspace   Workspace              @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  projects    Project[]
  members     ProjectSpaceMember[]

  @@index([workspaceId], map: "idx_project_spaces_workspace")
  @@map("project_spaces")
}

model ProjectSpaceMember {
  id             String       @id @default(cuid())
  projectSpaceId String
  userId         String
  joinedAt       DateTime     @default(now())
  projectSpace   ProjectSpace @relation(fields: [projectSpaceId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectSpaceId, userId])
  @@index([userId], map: "idx_project_space_members_user")
  @@index([projectSpaceId], map: "idx_project_space_members_space")
  @@map("project_space_members")
}

model Project {
  id                  String                 @id @default(cuid())
  workspaceId         String
  name                String
  description         String?
  status              ProjectStatus          @default(ACTIVE)
  priority            Priority               @default(MEDIUM)
  startDate           DateTime?
  endDate             DateTime?
  color               String?
  isArchived          Boolean                @default(false)
  department          String?
  team                String?
  wikiPageId          String?
  ownerId             String?
  projectSpaceId      String?
  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt
  createdById         String
  dailySummaryEnabled Boolean                @default(false)
  customFields        CustomFieldDef[]
  epics               Epic[]
  milestones          Milestone[]
  assignees           ProjectAssignee[]
  dailySummaries      ProjectDailySummary[]
  documentationLinks  ProjectDocumentation[]
  members             ProjectMember[]
  watchers            ProjectWatcher[]
  createdBy           User                   @relation(fields: [createdById], references: [id], onDelete: Cascade)
  owner               User?                  @relation("ProjectOwner", fields: [ownerId], references: [id])
  wikiPage            WikiPage?              @relation("ProjectPrimaryWiki", fields: [wikiPageId], references: [id])
  workspace           Workspace              @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  projectSpace        ProjectSpace?          @relation(fields: [projectSpaceId], references: [id], onDelete: SetNull)
  tasks               Task[]

  @@index([workspaceId, status], map: "idx_projects_workspace_status")
  @@index([updatedAt(sort: Desc)], map: "idx_projects_updated_at")
  @@index([projectSpaceId], map: "idx_projects_project_space")
  @@map("projects")
}

model Task {
  id                String            @id @default(cuid())
  projectId         String
  workspaceId       String
  title             String
  description       String?
  status            ProjectTaskStatus @default(TODO)
  priority          Priority          @default(MEDIUM)
  assigneeId        String?
  dueDate           DateTime?
  completedAt       DateTime?
  order             Int               @default(0)
  tags              String[]
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  createdById       String
  blocks            String[]
  dependsOn         String[]
  epicId            String?
  milestoneId       String?
  points            Int?
  customFieldValues CustomFieldVal[]
  subtasks          Subtask[]
  comments          TaskComment[]
  history           TaskHistory[]
  assignee          User?             @relation("TaskAssignee", fields: [assigneeId], references: [id])
  createdBy         User              @relation("TaskCreator", fields: [createdById], references: [id], onDelete: Cascade)
  epic              Epic?             @relation(fields: [epicId], references: [id])
  milestone         Milestone?        @relation(fields: [milestoneId], references: [id])
  project           Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  workspace         Workspace         @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([projectId, status], map: "idx_tasks_project_status")
  @@index([workspaceId, assigneeId], map: "idx_tasks_workspace_assignee")
  @@index([epicId], map: "idx_tasks_epic")
  @@index([milestoneId], map: "idx_tasks_milestone")
  @@index([workspaceId, status], map: "idx_tasks_workspace_status")
  @@map("tasks")
}

model Subtask {
  id          String            @id @default(cuid())
  taskId      String
  title       String
  description String?
  status      ProjectTaskStatus @default(TODO)
  assigneeId  String?
  dueDate     DateTime?
  completedAt DateTime?
  order       Int               @default(0)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  assignee    User?             @relation(fields: [assigneeId], references: [id])
  task        Task              @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId, order], map: "idx_subtasks_task_order")
  @@map("subtasks")
}

model TaskComment {
  id        String   @id @default(cuid())
  taskId    String
  userId    String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  mentions  String[]
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([taskId, createdAt(sort: Desc)], map: "idx_task_comments_task_created")
  @@map("task_comments")
}

model ProjectMember {
  id        String      @id @default(cuid())
  projectId String
  userId    String
  role      ProjectRole @default(MEMBER)
  joinedAt  DateTime    @default(now())
  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([userId], map: "idx_project_members_user")
  @@map("project_members")
}

model ProjectWatcher {
  id        String   @id @default(cuid())
  projectId String
  userId    String
  addedAt   DateTime @default(now())
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User     @relation("ProjectWatcher", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@map("project_watchers")
}

model ProjectAssignee {
  id         String   @id @default(cuid())
  projectId  String
  userId     String
  role       String?
  assignedAt DateTime @default(now())
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user       User     @relation("ProjectAssignee", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@map("project_assignees")
}

model FeatureFlag {
  id          String    @id @default(cuid())
  workspaceId String
  key         String
  enabled     Boolean   @default(false)
  audience    Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, key])
  @@index([workspaceId, key], map: "idx_feature_flags_workspace_key")
  @@map("feature_flags")
}

model ProjectTemplate {
  id           String    @id @default(cuid())
  workspaceId  String
  name         String
  description  String?
  category     String
  isDefault    Boolean   @default(false)
  isPublic     Boolean   @default(true)
  templateData Json
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  createdById  String
  createdBy    User      @relation(fields: [createdById], references: [id], onDelete: Cascade)
  workspace    Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@map("project_templates")
}

model Activity {
  id        String   @id @default(cuid())
  actorId   String
  entity    String
  entityId  String
  action    String
  meta      Json?
  createdAt DateTime @default(now())
  actor     User     @relation(fields: [actorId], references: [id], onDelete: Cascade)

  @@index([actorId, entity, entityId], map: "idx_activities_actor_entity")
  @@index([createdAt(sort: Desc)], map: "idx_activities_created")
  @@map("activities")
}

model TaskTemplate {
  id          String               @id @default(cuid())
  workspaceId String
  name        String
  description String?
  category    TaskTemplateCategory
  isPublic    Boolean              @default(false)
  metadata    Json?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  createdById String
  tasks       TaskTemplateItem[]
  createdBy   User                 @relation("TaskTemplateCreator", fields: [createdById], references: [id], onDelete: Cascade)
  workspace   Workspace            @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId, category], map: "idx_task_templates_workspace_category")
  @@map("task_templates")
}

model TaskTemplateItem {
  id                String            @id @default(cuid())
  templateId        String
  title             String
  description       String?
  status            ProjectTaskStatus @default(TODO)
  priority          Priority          @default(MEDIUM)
  estimatedDuration Int?
  assigneeRole      String?
  tags              String[]
  dependencies      String[]
  order             Int               @default(0)
  template          TaskTemplate      @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@map("task_template_items")
}

model onboarding_task_assignments {
  id               String         @id
  planId           String
  taskId           String
  status           TaskStatus     @default(PENDING)
  completedAt      DateTime?
  notes            String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime
  onboarding_plans OnboardingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  onboarding_tasks OnboardingTask @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([planId, taskId])
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model wiki_ai_interactions {
  id               String    @id @db.VarChar(50)
  page_id          String?   @db.VarChar(50)
  user_id          String    @db.VarChar(50)
  interaction_type String    @db.VarChar(50)
  input_data       Json?
  output_data      Json?
  created_at       DateTime? @default(now()) @db.Timestamp(6)
  wiki_pages       WikiPage? @relation(fields: [page_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users            User      @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([created_at(sort: Desc)], map: "idx_wiki_ai_interactions_created_at")
  @@index([page_id], map: "idx_wiki_ai_interactions_page_id")
  @@index([interaction_type], map: "idx_wiki_ai_interactions_type")
  @@index([user_id], map: "idx_wiki_ai_interactions_user_id")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model wiki_page_views {
  id         String    @id @db.VarChar(50)
  page_id    String    @db.VarChar(50)
  user_id    String?   @db.VarChar(50)
  viewed_at  DateTime? @default(now()) @db.Timestamp(6)
  ip_address String?   @db.Inet
  user_agent String?
  wiki_pages WikiPage  @relation(fields: [page_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users      User?     @relation(fields: [user_id], references: [id], onUpdate: NoAction)

  @@index([page_id], map: "idx_wiki_page_views_page_id")
  @@index([user_id], map: "idx_wiki_page_views_user_id")
  @@index([viewed_at(sort: Desc)], map: "idx_wiki_page_views_viewed_at")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model wiki_workspaces {
  id            String    @id @db.VarChar(50)
  workspace_id  String    @db.VarChar(50)
  name          String    @db.VarChar(255)
  type          String?   @default("team") @db.VarChar(50)
  color         String?   @default("#3b82f6") @db.VarChar(7)
  icon          String?   @default("layers") @db.VarChar(50)
  description   String?
  is_private    Boolean?  @default(false)
  created_by_id String    @db.VarChar(50)
  created_at    DateTime? @default(now()) @db.Timestamp(6)
  updated_at    DateTime? @default(now()) @db.Timestamp(6)
  users         User      @relation(fields: [created_by_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  workspaces    Workspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([created_by_id], map: "idx_wiki_workspaces_created_by")
  @@index([type], map: "idx_wiki_workspaces_type")
  @@index([workspace_id], map: "idx_wiki_workspaces_workspace_id")
}

model Epic {
  id          String   @id @default(cuid())
  workspaceId String
  projectId   String
  title       String
  description String?
  color       String?
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks       Task[]

  @@index([projectId, order], map: "idx_epics_project_order")
  @@map("epics")
}

model Milestone {
  id          String    @id @default(cuid())
  workspaceId String
  projectId   String
  title       String
  description String?
  startDate   DateTime?
  endDate     DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks       Task[]

  @@index([projectId, startDate], map: "idx_milestones_project_start")
  @@map("milestones")
}

model CustomFieldDef {
  id        String           @id @default(cuid())
  projectId String
  key       String
  label     String
  type      String
  options   Json?
  uniqueKey String           @unique
  createdAt DateTime         @default(now())
  project   Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  values    CustomFieldVal[]

  @@index([projectId, key], map: "idx_custom_field_defs_project_key")
  @@map("custom_field_defs")
}

model CustomFieldVal {
  id      String         @id @default(cuid())
  taskId  String
  fieldId String
  value   Json
  field   CustomFieldDef @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  task    Task           @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([taskId, fieldId])
  @@index([taskId], map: "idx_custom_field_vals_task")
  @@index([fieldId], map: "idx_custom_field_vals_field")
  @@map("custom_field_vals")
}

model TaskHistory {
  id      String   @id @default(cuid())
  taskId  String
  actorId String
  field   String
  from    Json?
  to      Json?
  at      DateTime @default(now())
  actor   User     @relation(fields: [actorId], references: [id], onDelete: Cascade)
  task    Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId, at(sort: Desc)], map: "idx_task_history_task_at")
  @@map("task_history")
}

model ProjectDailySummary {
  id        String   @id @default(cuid())
  projectId String
  date      DateTime @db.Date
  text      String
  createdAt DateTime @default(now())
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, date])
  @@index([projectId, date(sort: Desc)], map: "idx_project_daily_summary_project_date")
  @@map("project_daily_summaries")
}

model ProjectDocumentation {
  id         String   @id @default(cuid())
  projectId  String
  wikiPageId String
  order      Int      @default(0)
  createdAt  DateTime @default(now())
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  wikiPage   WikiPage @relation(fields: [wikiPageId], references: [id], onDelete: Cascade)

  @@unique([projectId, wikiPageId])
  @@index([projectId], map: "idx_project_documentation_project")
  @@index([wikiPageId], map: "idx_project_documentation_wiki_page")
  @@map("project_documentation")
}

model BlogPost {
  id          String           @id @default(cuid())
  title       String
  slug        String           @unique
  excerpt     String
  content     String
  category    BlogPostCategory @default(NEWS)
  status      BlogPostStatus   @default(DRAFT)
  publishedAt DateTime?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([slug])
  @@index([status])
  @@index([category])
  @@index([publishedAt(sort: Desc)])
  @@map("blog_posts")
}

/// *
///  * ContextItem - Canonical storage for ContextObject instances
///  * Stores the full serialized ContextObject in JSON format for queryable persistence
model ContextItem {
  id              String            @id @default(cuid())
  contextId       String
  workspaceId     String
  type            String
  title           String
  summary         String?
  data            Json
  updatedAt       DateTime          @updatedAt
  createdAt       DateTime          @default(now())
  embedding       ContextEmbedding?
  summaryRelation ContextSummary?

  @@index([workspaceId, type], map: "idx_context_items_workspace_type")
  @@index([contextId, type], map: "idx_context_items_context_type")
  @@index([workspaceId, updatedAt(sort: Desc)], map: "idx_context_items_workspace_updated")
  @@map("context_items")
}

/// *
///  * ContextEmbedding - Vector storage for semantic search
///  * Stores embeddings for ContextItem instances to enable vector similarity search
///  * TODO: Replace Float[] with Vector type after enabling pgvector extension in Step 4
///  * TODO: Add vector index: @@index([embedding], type: "vector") after pgvector setup
model ContextEmbedding {
  id            String      @id @default(cuid())
  contextItemId String      @unique
  embedding     Float[]
  workspaceId   String
  updatedAt     DateTime    @updatedAt
  contextItem   ContextItem @relation(fields: [contextItemId], references: [id], onDelete: Cascade)

  @@index([workspaceId], map: "idx_context_embeddings_workspace")
  @@map("context_embeddings")
}

/// *
///  * ContextSummary - Pre-computed LLM-generated summaries
///  * Stores cached text summaries for ContextItem instances to reduce LLM calls
model ContextSummary {
  id            String      @id @default(cuid())
  contextItemId String      @unique
  summary       String
  workspaceId   String
  updatedAt     DateTime    @updatedAt
  createdAt     DateTime    @default(now())
  contextItem   ContextItem @relation(fields: [contextItemId], references: [id], onDelete: Cascade)

  @@index([workspaceId], map: "idx_context_summaries_workspace")
  @@map("context_summaries")
}

enum WorkspaceRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum ViewerScopeType {
  WORKSPACE_READONLY
  TEAM_READONLY
  PROJECTS_ONLY
}

enum OnboardingStatus {
  ACTIVE
  COMPLETED
  PAUSED
  CANCELLED
}

enum WorkflowStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  FAILED
}

enum AssignmentStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  REJECTED
}

enum MigrationStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  CANCELLED
}

enum IntegrationType {
  SLACK
  GOOGLE_DRIVE
  MICROSOFT_TEAMS
  ZOOM
  SLITE
  CLICKUP
  NOTION
  CONFLUENCE
  ASANA
  TRELLO
  MONDAY
}

enum MessageType {
  USER
  AI
}

enum ProjectStatus {
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum TaskTemplateCategory {
  SOFTWARE_DEVELOPMENT
  MARKETING_CAMPAIGN
  EVENT_PLANNING
  PRODUCT_LAUNCH
  GENERAL
}

enum ProjectTaskStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  DONE
  BLOCKED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ProjectRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

enum BlogPostStatus {
  DRAFT
  PUBLISHED
}

enum BlogPostCategory {
  NEWS
  PRODUCT
  CONTEXTUAL_AI
  LOOPWELL
}

enum ProjectSpaceVisibility {
  PUBLIC
  TARGETED
}
