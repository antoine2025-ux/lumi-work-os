# Loopwell System Flow - Visual Diagram

## Overview
This document provides a comprehensive visual representation of the Loopwell AI Assistant system flow, showing how users interact with the AI in different contexts and how content is generated and managed.

## Main System Flow - ASCII Diagram

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              USER ENTRY POINTS                                     │
├──────────────────────────────────────┬────────────────────────────────────────────┤
│      Inside Page (Page Context)      │      Home/Dashboard (Global Mode)          │
└──────────────┬───────────────────────┴──────────────┬─────────────────────────────┘
               │                                      │
               ▼                                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          PAGE CONTEXT MODE FLOW                                    │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  ┌──────────────────┐                                                              │
│  │ AI Detects Page  │                                                              │
│  │ Context (pageId) │                                                              │
│  └────────┬─────────┘                                                              │
│           │                                                                         │
│           ▼                                                                         │
│  ┌──────────────────┐                                                              │
│  │ User Gives       │                                                              │
│  │ Request          │                                                              │
│  │ e.g., "create    │                                                              │
│  │  device policy"  │                                                              │
│  └────────┬─────────┘                                                              │
│           │                                                                         │
│           ▼                                                                         │
│  ┌──────────────────┐                                                              │
│  │ Interpret Intent │                                                              │
│  └────────┬─────────┘                                                              │
│           │                                                                         │
│           ├─────────────────┐                                                      │
│           │                 │                                                      │
│           ▼                 ▼                                                      │
│  ┌──────────────┐   ┌──────────────────┐                                          │
│  │ Draft for    │   │ Explicit "new    │                                          │
│  │ current page │   │ page"? Ask:      │                                          │
│  │ (default)    │   │ "Draft here or   │                                          │
│  └──────┬───────┘   │ new page?"       │                                          │
│         │           └────────┬─────────┘                                          │
│         │                    │                                                      │
│         └──────────┬─────────┘                                                      │
│                    │                                                                 │
│                    ▼                                                                 │
│         ┌──────────────────┐                                                         │
│         │ Target: Current  │                                                         │
│         │ Page             │                                                         │
│         └────────┬─────────┘                                                         │
│                  │                                                                   │
│                  ▼                                                                   │
│         ┌──────────────────┐                                                         │
│         │ AI Generates     │                                                         │
│         │ Full Markdown    │                                                         │
│         └────────┬─────────┘                                                         │
│                  │                                                                   │
│                  ▼                                                                   │
│         ┌──────────────────┐                                                         │
│         │ Stream Content   │                                                         │
│         │ into Editor      │                                                         │
│         │ (Typing Effect)  │                                                         │
│         └────────┬─────────┘                                                         │
│                  │                                                                   │
│                  ▼                                                                   │
│         ┌──────────────────┐                                                         │
│         │ Assistant Panel  │                                                         │
│         │ Stays Open       │                                                         │
│         └────────┬─────────┘                                                         │
│                  │                                                                   │
│                  ▼                                                                   │
│         ┌──────────────────┐                                                         │
│         │ User Actions     │                                                         │
│         │ • Ask Follow-ups │                                                         │
│         │ • Request Edits  │                                                         │
│         │ • Done           │                                                         │
│         └────────┬─────────┘                                                         │
│                  │                                                                   │
│                  ▼                                                                   │
│         ┌──────────────────┐                                                         │
│         │ Content Drafted  │                                                         │
│         │ ✓                │                                                         │
│         └──────────────────┘                                                         │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           GLOBAL MODE FLOW                                         │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  ┌──────────────────┐                                                              │
│  │ AI Detects       │                                                              │
│  │ Global Context   │                                                              │
│  │ (No pageId)      │                                                              │
│  └────────┬─────────┘                                                              │
│           │                                                                         │
│           ▼                                                                         │
│  ┌──────────────────┐                                                              │
│  │ User Gives       │                                                              │
│  │ Request          │                                                              │
│  │ e.g., "create    │                                                              │
│  │  device policy"  │                                                              │
│  └────────┬─────────┘                                                              │
│           │                                                                         │
│           ▼                                                                         │
│  ┌──────────────────┐                                                              │
│  │ Interpret as:    │                                                              │
│  │ Create New Page  │                                                              │
│  └────────┬─────────┘                                                              │
│           │                                                                         │
│           ▼                                                                         │
│  ┌──────────────────┐                                                              │
│  │ Ask 2 Questions: │                                                              │
│  │ 1. Location:     │                                                              │
│  │    Space/Project?│                                                              │
│  │ 2. Title:        │                                                              │
│  │    Suggest/Ask   │                                                              │
│  └────────┬─────────┘                                                              │
│           │                                                                         │
│           ▼                                                                         │
│  ┌──────────────────┐                                                              │
│  │ System Creates   │                                                              │
│  │ New Page in      │                                                              │
│  │ Chosen Location  │                                                              │
│  └────────┬─────────┘                                                              │
│           │                                                                         │
│           ▼                                                                         │
│  ┌──────────────────┐                                                              │
│  │ Navigate to      │                                                              │
│  │ New Page         │                                                              │
│  │ (AI Assistant    │                                                              │
│  │  Remains Open)   │                                                              │
│  └────────┬─────────┘                                                              │
│           │                                                                         │
│           ▼                                                                         │
│  ┌──────────────────┐                                                              │
│  │ AI Generates     │                                                              │
│  │ Full Markdown    │                                                              │
│  └────────┬─────────┘                                                              │
│           │                                                                         │
│           ▼                                                                         │
│  ┌──────────────────┐                                                              │
│  │ Stream Content   │                                                              │
│  │ into Editor      │                                                              │
│  │ (Line by Line)   │                                                              │
│  └────────┬─────────┘                                                              │
│           │                                                                         │
│           ▼                                                                         │
│  ┌──────────────────┐                                                              │
│  │ Assistant Panel  │                                                              │
│  │ Stays Open       │                                                              │
│  └────────┬─────────┘                                                              │
│           │                                                                         │
│           ▼                                                                         │
│  ┌──────────────────┐                                                              │
│  │ User Actions     │                                                              │
│  │ • Revise         │                                                              │
│  │ • Regenerate     │                                                              │
│  │ • Append         │                                                              │
│  │ • Done           │                                                              │
│  └────────┬─────────┘                                                              │
│           │                                                                         │
│           ▼                                                                         │
│  ┌──────────────────┐                                                              │
│  │ New Page Created │                                                              │
│  │ & Drafted ✓      │                                                              │
│  └──────────────────┘                                                              │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## Page Creation Decision Logic - ASCII Diagram

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                        PAGE CREATION DECISION TREE                                  │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│                              ┌──────────────┐                                       │
│                              │ User Request │                                       │
│                              └──────┬───────┘                                       │
│                                     │                                               │
│                                     ▼                                               │
│                            ┌─────────────────┐                                      │
│                            │ pageId exists?  │                                      │
│                            └────────┬────────┘                                      │
│                                     │                                               │
│                    ┌────────────────┴────────────────┐                            │
│                    │                                  │                            │
│                    ▼                                  ▼                            │
│          ┌─────────────────┐            ┌──────────────────┐                      │
│          │ Inside Page     │            │ No Page Context  │                      │
│          │ (Yes)           │            │ (No)             │                      │
│          └────────┬────────┘            └────────┬─────────┘                      │
│                   │                               │                                │
│                   ▼                               │                                │
│          ┌─────────────────┐                      │                                │
│          │ Intent Check    │                      │                                │
│          └────────┬────────┘                      │                                │
│                   │                               │                                │
│      ┌────────────┴────────────┐                  │                                │
│      │                         │                  │                                │
│      ▼                         ▼                  │                                │
│ ┌──────────────┐    ┌──────────────────┐         │                                │
│ │ "Draft for   │    │ "Create new      │         │                                │
│ │  this page"  │    │  page"?          │         │                                │
│ └──────┬───────┘    └────────┬─────────┘         │                                │
│        │                     │                    │                                │
│        │                     ▼                    │                                │
│        │            ┌──────────────────┐          │                                │
│        │            │ Ask User:        │          │                                │
│        │            │ "Draft here or   │          │                                │
│        │            │  create new?"    │          │                                │
│        │            └────────┬─────────┘          │                                │
│        │                     │                    │                                │
│        │                     ▼                    │                                │
│        │            ┌──────────────────┐          │                                │
│        │            │ User Choice     │          │                                │
│        │            └────────┬─────────┘          │                                │
│        │                     │                    │                                │
│        │         ┌───────────┴───────────┐        │                                │
│        │         │                       │        │                                │
│        │         ▼                       ▼        │                                │
│        │  ┌──────────────┐    ┌──────────────┐  │                                │
│        │  │ Current Page  │    │ Ask Location │  │                                │
│        │  └──────┬───────┘    └──────┬───────┘  │                                │
│        │         │                    │          │                                │
│        └─────────┼────────────────────┘          │                                │
│                  │                               │                                │
│                  │                               ▼                                │
│                  │                      ┌──────────────────┐                       │
│                  │                      │ Ask Location &   │                       │
│                  │                      │ Title            │                       │
│                  │                      └────────┬─────────┘                       │
│                  │                               │                                 │
│                  │                               ▼                                 │
│                  │                      ┌──────────────────┐                       │
│                  │                      │ Create New Page  │                       │
│                  │                      └────────┬─────────┘                       │
│                  │                               │                                 │
│                  │                               ▼                                 │
│                  │                      ┌──────────────────┐                       │
│                  │                      │ Write to New     │                       │
│                  │                      │ Page             │                       │
│                  │                      └────────┬─────────┘                       │
│                  │                               │                                 │
│                  └───────────────┬───────────────┘                                 │
│                                  │                                                 │
│                                  ▼                                                 │
│                         ┌──────────────────┐                                       │
│                         │ Write to Current │                                       │
│                         │ Page             │                                       │
│                         └────────┬─────────┘                                       │
│                                  │                                                 │
│                                  ▼                                                 │
│                         ┌──────────────────┐                                       │
│                         │ Stream Markdown  │                                       │
│                         │ into Editor      │                                       │
│                         └────────┬─────────┘                                       │
│                                  │                                                 │
│                                  ▼                                                 │
│                         ┌──────────────────┐                                       │
│                         │ Content Drafted  │                                       │
│                         │ ✓                │                                       │
│                         └──────────────────┘                                       │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## Contextual AI Intelligence Flow - ASCII Diagram

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                    CONTEXTUAL AI INTELLIGENCE FLOW                                  │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                         User Asks Question                                  │   │
│  │              e.g., "What's the status of Project X?"                        │   │
│  └──────────────────────────────┬──────────────────────────────────────────────┘   │
│                                 │                                                  │
│                                 ▼                                                  │
│                    ┌────────────────────────────┐                                 │
│                    │ AI Retrieves Context       │                                 │
│                    └────────────┬───────────────┘                                 │
│                                 │                                                  │
│         ┌───────────────────────┼───────────────────────┐                          │
│         │                       │                       │                          │
│         ▼                       ▼                       ▼                          │
│  ┌──────────────┐      ┌──────────────┐      ┌──────────────┐                   │
│  │ Tasks &      │      │ Blockers     │      │ Meeting      │                   │
│  │ Statuses     │      │              │      │ Notes        │                   │
│  └──────┬───────┘      └──────┬───────┘      └──────┬───────┘                   │
│         │                     │                      │                            │
│         └─────────────────────┼──────────────────────┘                            │
│                               │                                                     │
│         ┌─────────────────────┼───────────────────────┐                            │
│         │                     │                       │                            │
│         ▼                     ▼                       ▼                            │
│  ┌──────────────┐      ┌──────────────┐      ┌──────────────┐                   │
│  │ Project      │      │ Role         │      │ Deadlines    │                   │
│  │ Documents    │      │ Responsibilities│    │              │                   │
│  └──────┬───────┘      └──────┬───────┘      └──────┬───────┘                   │
│         │                     │                      │                            │
│         └─────────────────────┼──────────────────────┘                            │
│                               │                                                     │
│                               ▼                                                     │
│                    ┌────────────────────────────┐                                 │
│                    │ AI Synthesizes Data         │                                 │
│                    │ • Cross-references sources  │                                 │
│                    │ • Identifies patterns       │                                 │
│                    │ • Finds relationships       │                                 │
│                    └────────────┬───────────────┘                                 │
│                                 │                                                  │
│                                 ▼                                                  │
│                    ┌────────────────────────────┐                                 │
│                    │ AI Outputs Grounded Answer  │                                 │
│                    └────────────┬───────────────┘                                 │
│                                 │                                                  │
│         ┌───────────────────────┼───────────────────────┐                          │
│         │                       │                       │                          │
│         ▼                       ▼                       ▼                          │
│  ┌──────────────┐      ┌──────────────┐      ┌──────────────┐                   │
│  │ Summary      │      │ Risks        │      │ Next Steps   │                   │
│  │              │      │              │      │              │                   │
│  └──────────────┘      └──────────────┘      └──────────────┘                   │
│         │                       │                       │                          │
│         └───────────────────────┼───────────────────────┘                          │
│                                 │                                                  │
│         ┌───────────────────────┼───────────────────────┐                          │
│         │                       │                       │                          │
│         ▼                       ▼                       ▼                          │
│  ┌──────────────┐      ┌──────────────────────────────┐                          │
│  │ Recommended  │      │ Optional Follow-up           │                          │
│  │ Actions      │      │ "Should I notify John?"      │                          │
│  └──────────────┘      └──────────────────────────────┘                          │
│                                                                                     │
│  AI Context Access:                                                                 │
│  • Projects          • Epics          • Tasks                                       │
│  • HRIS Data         • Documentation  • Meeting Notes                              │
│  • User Activity     • Org Structure                                                │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## AI Drafting Flow (Universal) - ASCII Diagram

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                        AI DRAFTING FLOW - SEQUENCE                                  │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  User                    AI                    System              Editor          │
│   │                      │                      │                    │              │
│   │─── Request ─────────►│                      │                    │              │
│   │   "create device     │                      │                    │              │
│   │    policy"           │                      │                    │              │
│   │                      │                      │                    │              │
│   │                      │─── Determine ────────┤                    │              │
│   │                      │    Target Page       │                    │              │
│   │                      │    (current/new)     │                    │              │
│   │                      │                      │                    │              │
│   │                      │─── Prepare ─────────►│                    │              │
│   │                      │    Page Editor       │                    │              │
│   │                      │                      │                    │              │
│   │                      │                      │─── Initialize ─────►│              │
│   │                      │                      │    Editor          │              │
│   │                      │                      │                    │              │
│   │                      │─── Begin ───────────┼───────────────────►│              │
│   │                      │    Streaming        │                    │              │
│   │                      │    Markdown         │                    │              │
│   │                      │                      │                    │              │
│   │                      │                      │                    │              │
│   │                      │    ┌────────────────────────────────────┐ │              │
│   │                      │    │ For Each Chunk:                    │ │              │
│   │                      │    │  Stream Markdown Chunk             │ │              │
│   │                      │    │  Editor Updates Live               │ │              │
│   │                      │    │  (Typing Effect)                   │ │              │
│   │                      │    └────────────────────────────────────┘ │              │
│   │                      │                      │                    │              │
│   │                      │                      │                    │              │
│   │                      │                      │◄─── Update ────────┤              │
│   │                      │                      │    Live            │              │
│   │◄─── Content ─────────┤                      │                    │              │
│   │    Complete          │                      │                    │              │
│   │                      │                      │                    │              │
│   │                      │                      │                    │              │
│   │                      │                      │                    │              │
│   │                      │    ┌─────────────────────────────────┐  │              │
│   │                      │    │ Assistant Stays Visible          │  │              │
│   │                      │    └─────────────────────────────────┘  │              │
│   │                      │                      │                    │              │
│   │                      │                      │                    │              │
│   │─── Regenerate ──────►│                      │                    │              │
│   │    Section?          │                      │                    │              │
│   │                      │                      │                    │              │
│   │                      │─── Update ───────────┼───────────────────►│              │
│   │                      │    Specific Section  │                    │              │
│   │                      │                      │                    │              │
│   │                      │                      │                    │              │
│   │─── Modify ──────────►│                      │                    │              │
│   │    Content?          │                      │                    │              │
│   │                      │                      │                    │              │
│   │                      │─── Apply ────────────┼───────────────────►│              │
│   │                      │    Modifications     │                    │              │
│   │                      │                      │                    │              │
│                                                                                     │
│  Key Features:                                                                      │
│  • Content drafted INSIDE editor, not in chat bubbles                             │
│  • Always Markdown format (H1, H2, paragraphs, lists)                              │
│  • No code blocks around content                                                   │
│  • Proper spacing maintained                                                       │
│  • Streaming enabled for typing effect                                             │
│  • Never leaves page blank after creation                                          │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## Complete System Overview - ASCII Diagram

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                         COMPLETE SYSTEM OVERVIEW                                    │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                            ENTRY POINTS                                     │   │
│  ├────────────────────────────────────┬────────────────────────────────────────┤   │
│  │  Inside Page                       │  Home/Global                          │   │
│  │  (Page Context Mode)               │  (Global Mode)                         │   │
│  └──────────────┬─────────────────────┴──────────────┬────────────────────────┘   │
│                 │                                      │                            │
│                 ▼                                      ▼                            │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                      PAGE CONTEXT FLOW                                      │   │
│  │                                                                             │   │
│  │  Detect Page Context → Interpret Intent → Draft into Current Page         │   │
│  │                                                                             │   │
│  │  → Stream Markdown → Assistant Stays Open                                  │   │
│  └──────────────────────────────┬──────────────────────────────────────────────┘   │
│                                 │                                                  │
│                                 │                                                  │
│  ┌──────────────────────────────┼──────────────────────────────────────────────┐   │
│  │                      GLOBAL MODE FLOW                                        │   │
│  │                                                                             │   │
│  │  Detect Global Context → Ask Location & Title → Create New Page            │   │
│  │                                                                             │   │
│  │  → Navigate to Page → Draft into New Page → Stream Markdown                │   │
│  │                                                                             │   │
│  │  → Assistant Stays Open                                                     │   │
│  └──────────────────────────────┬──────────────────────────────────────────────┘   │
│                                 │                                                  │
│                                 │                                                  │
│                                 ▼                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                        CONTEXTUAL AI                                       │   │
│  │                                                                             │   │
│  │  Retrieve Org Data → Synthesize Insights → Output Contextual Answers       │   │
│  │                                                                             │   │
│  │  Data Sources:                                                              │   │
│  │  • Projects    • Epics      • Tasks                                        │   │
│  │  • HRIS Data   • Docs        • Meeting Notes                               │   │
│  │  • User Activity • Org Structure                                           │   │
│  └──────────────────────────────┬──────────────────────────────────────────────┘   │
│                                 │                                                  │
│                                 ▼                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                      EDITOR INTEGRATION                                    │   │
│  │                                                                             │   │
│  │  AI Drafts in Editor → Markdown Format → Streaming Enabled                 │   │
│  │                                                                             │   │
│  │  → No Code Blocks → Proper Spacing → Never Blank                           │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                    ADMIN SETUP FLOW (HRIS)                                  │   │
│  │                                                                             │   │
│  │  New Workspace → Org Setup Wizard                                          │   │
│  │                                                                             │   │
│  │  → Create Departments (AI can generate descriptions)                       │   │
│  │  → Create Teams (AI can generate team purpose)                             │   │
│  │  → Create Role Cards (AI can generate content)                             │   │
│  │  → Assign Job Titles                                                       │   │
│  │  → Invite Members (AI can generate onboarding templates)                   │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                    PROJECT MANAGEMENT FLOW                                  │   │
│  │                                                                             │   │
│  │  Create Project → Define Epics → Create Tasks                              │   │
│  │                                                                             │   │
│  │  → Board View (All Tasks) / Epic View (Epic Tasks)                         │   │
│  │                                                                             │   │
│  │  AI Capabilities:                                                           │   │
│  │  • Generate Project Plan    • Find Blockers                                │   │
│  │  • Summarize Status         • Suggest Missing Tasks                        │   │
│  │  • Align Roles with Responsibilities                                        │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## Main System Flow Diagram (Mermaid)

```mermaid
flowchart TD
    Start([User Starts]) --> Entry{Entry Point?}
    
    Entry -->|Inside Page| PageContext[Page Context Mode]
    Entry -->|Home/Dashboard| GlobalContext[Global Mode]
    
    %% Page Context Mode Flow
    PageContext --> DetectPage[AI Detects Page Context<br/>pageId exists]
    DetectPage --> ReceiveRequest1[User Gives Request<br/>e.g., 'create device policy']
    ReceiveRequest1 --> Interpret1{Interpret Intent}
    
    Interpret1 -->|Draft for current page| DraftCurrent[Target: Current Page]
    Interpret1 -->|Explicit 'new page'| AskClarify1[Ask: 'Draft here or new page?']
    AskClarify1 --> DraftCurrent
    
    DraftCurrent --> GenerateContent1[AI Generates Full Markdown]
    GenerateContent1 --> Stream1[Stream Content into Editor<br/>Typing Effect]
    Stream1 --> AssistantOpen1[Assistant Panel Stays Open]
    AssistantOpen1 --> FollowUp1{User Actions}
    FollowUp1 -->|Ask Follow-ups| ReceiveRequest1
    FollowUp1 -->|Request Edits| GenerateContent1
    FollowUp1 -->|Done| End1([Content Drafted])
    
    %% Global Mode Flow
    GlobalContext --> DetectGlobal[AI Detects Global Context<br/>No pageId]
    DetectGlobal --> ReceiveRequest2[User Gives Request<br/>e.g., 'create device policy']
    ReceiveRequest2 --> Interpret2[Interpret as: Create New Page]
    Interpret2 --> AskLocation[Ask 2 Questions:<br/>1. Location: Space/Project?<br/>2. Title: Suggest or ask]
    AskLocation --> CreatePage[System Creates New Page<br/>in Chosen Location]
    CreatePage --> Navigate[Navigate to New Page<br/>AI Assistant Remains Open]
    Navigate --> GenerateContent2[AI Generates Full Markdown]
    GenerateContent2 --> Stream2[Stream Content into Editor<br/>Line by Line]
    Stream2 --> AssistantOpen2[Assistant Panel Stays Open]
    AssistantOpen2 --> FollowUp2{User Actions}
    FollowUp2 -->|Revise| GenerateContent2
    FollowUp2 -->|Regenerate| GenerateContent2
    FollowUp2 -->|Append| GenerateContent2
    FollowUp2 -->|Done| End2([New Page Created & Drafted])
    
    %% Styling
    classDef pageMode fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    classDef globalMode fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef decision fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef action fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    classDef endpoint fill:#fff9c4,stroke:#f57f17,stroke-width:3px
    
    class PageContext,DetectPage,ReceiveRequest1,Interpret1,DraftCurrent,GenerateContent1,Stream1,AssistantOpen1,FollowUp1,End1 pageMode
    class GlobalContext,DetectGlobal,ReceiveRequest2,Interpret2,AskLocation,CreatePage,Navigate,GenerateContent2,Stream2,AssistantOpen2,FollowUp2,End2 globalMode
    class Entry,Interpret1,FollowUp1,FollowUp2 decision
    class GenerateContent1,GenerateContent2,Stream1,Stream2 action
    class Start,End1,End2 endpoint
```

## Contextual AI Intelligence Flow

```mermaid
flowchart LR
    UserQuestion[User Asks Question<br/>e.g., 'Status of Project X?'] --> RetrieveContext[AI Retrieves Context]
    
    RetrieveContext --> Data1[Tasks & Statuses]
    RetrieveContext --> Data2[Blockers]
    RetrieveContext --> Data3[Meeting Notes]
    RetrieveContext --> Data4[Project Documents]
    RetrieveContext --> Data5[Role Responsibilities]
    RetrieveContext --> Data6[Deadlines]
    
    Data1 --> Synthesize[AI Synthesizes Data]
    Data2 --> Synthesize
    Data3 --> Synthesize
    Data4 --> Synthesize
    Data5 --> Synthesize
    Data6 --> Synthesize
    
    Synthesize --> Output[AI Outputs Grounded Answer]
    
    Output --> Summary[Summary]
    Output --> Risks[Risks]
    Output --> NextSteps[Next Steps]
    Output --> Recommendations[Recommended Actions]
    Output --> FollowUp[Optional Follow-up<br/>'Should I notify John?']
    
    classDef input fill:#e3f2fd,stroke:#0277bd,stroke-width:2px
    classDef data fill:#f1f8e9,stroke:#558b2f,stroke-width:2px
    classDef process fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef output fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    
    class UserQuestion input
    class Data1,Data2,Data3,Data4,Data5,Data6 data
    class RetrieveContext,Synthesize process
    class Output,Summary,Risks,NextSteps,Recommendations,FollowUp output
```

## Page Creation Decision Logic

```mermaid
flowchart TD
    Request[User Request] --> CheckPage{pageId exists?}
    
    CheckPage -->|Yes| InPage[Inside Page]
    CheckPage -->|No| NoPage[No Page Context]
    
    InPage --> CheckIntent{Intent Check}
    CheckIntent -->|'Draft for this page'| WriteCurrent[Write to Current Page]
    CheckIntent -->|'Create new page'| AskUser[Ask: 'Draft here or<br/>create new page?']
    
    AskUser --> UserChoice{User Choice}
    UserChoice -->|Current| WriteCurrent
    UserChoice -->|New| AskLocation2[Ask Location]
    
    NoPage --> AskLocation2[Ask Location & Title]
    AskLocation2 --> CreateNew[Create New Page]
    CreateNew --> WriteNew[Write to New Page]
    
    WriteCurrent --> StreamContent[Stream Markdown into Editor]
    WriteNew --> StreamContent
    StreamContent --> Complete([Content Drafted])
    
    classDef decision fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef action fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    classDef endpoint fill:#fff9c4,stroke:#f57f17,stroke-width:3px
    
    class CheckPage,CheckIntent,UserChoice decision
    class WriteCurrent,WriteNew,StreamContent action
    class Complete endpoint
```

## AI Drafting Flow (Universal)

```mermaid
sequenceDiagram
    participant User
    participant AI
    participant System
    participant Editor
    
    User->>AI: Request (e.g., "create device policy")
    AI->>AI: Determine Target Page<br/>(current or new)
    AI->>System: Prepare Page Editor
    System->>Editor: Initialize Editor
    AI->>Editor: Begin Streaming Markdown
    loop For Each Chunk
        AI->>Editor: Stream Markdown Chunk
        Editor->>User: Update Live (Typing Effect)
    end
    AI->>User: Content Complete
    Note over AI,Editor: Assistant Stays Visible
    User->>AI: Regenerate Section?
    AI->>Editor: Update Specific Section
    User->>AI: Modify Content?
    AI->>Editor: Apply Modifications
```

## Admin Setup Flow (HRIS)

```mermaid
flowchart TD
    NewWorkspace[New Loopwell Workspace Created] --> OrgWizard[Admin Enters<br/>Org Setup Wizard]
    
    OrgWizard --> Step1[Step 1: Create Departments]
    Step1 --> AIHelp1{AI Help?}
    AIHelp1 -->|Yes| GenerateDept[AI Generates<br/>Department Descriptions]
    AIHelp1 -->|No| Step2[Step 2: Create Teams]
    GenerateDept --> Step2
    
    Step2 --> AIHelp2{AI Help?}
    AIHelp2 -->|Yes| GenerateTeam[AI Generates<br/>Team Purpose]
    AIHelp2 -->|No| Step3[Step 3: Create Role Cards]
    GenerateTeam --> Step3
    
    Step3 --> AIHelp3{AI Help?}
    AIHelp3 -->|Yes| GenerateRole[AI Generates<br/>Role Card Content]
    AIHelp3 -->|No| Step4[Step 4: Assign Job Titles]
    GenerateRole --> Step4
    
    Step4 --> Step5[Step 5: Invite Members]
    Step5 --> AIHelp4{AI Help?}
    AIHelp4 -->|Yes| GenerateOnboarding[AI Generates<br/>Onboarding Templates]
    AIHelp4 -->|No| Complete([Setup Complete])
    GenerateOnboarding --> Complete
    
    classDef step fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    classDef ai fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef endpoint fill:#fff9c4,stroke:#f57f17,stroke-width:3px
    
    class Step1,Step2,Step3,Step4,Step5 step
    class AIHelp1,AIHelp2,AIHelp3,AIHelp4,GenerateDept,GenerateTeam,GenerateRole,GenerateOnboarding ai
    class Complete endpoint
```

## Project Management Flow

```mermaid
flowchart TD
    CreateProject[User Creates Project] --> DefineEpics[Define Epics]
    DefineEpics --> CreateTasks[Create Tasks]
    CreateTasks --> BoardView[Board View<br/>Shows All Tasks]
    CreateTasks --> EpicView[Epic View<br/>Shows Epic-Only Tasks]
    
    BoardView --> AICapabilities[AI Capabilities]
    EpicView --> AICapabilities
    
    AICapabilities --> GeneratePlan[Generate Project Plan]
    AICapabilities --> FindBlockers[Find Blockers]
    AICapabilities --> SummarizeStatus[Summarize Status]
    AICapabilities --> SuggestTasks[Suggest Missing Tasks]
    AICapabilities --> AlignRoles[Align Roles with<br/>Responsibilities]
    
    GeneratePlan --> ProjectComplete([Project Management])
    FindBlockers --> ProjectComplete
    SummarizeStatus --> ProjectComplete
    SuggestTasks --> ProjectComplete
    AlignRoles --> ProjectComplete
    
    classDef action fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    classDef view fill:#e3f2fd,stroke:#0277bd,stroke-width:2px
    classDef ai fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef endpoint fill:#fff9c4,stroke:#f57f17,stroke-width:3px
    
    class CreateProject,DefineEpics,CreateTasks action
    class BoardView,EpicView view
    class AICapabilities,GeneratePlan,FindBlockers,SummarizeStatus,SuggestTasks,AlignRoles ai
    class ProjectComplete endpoint
```

## Complete System Overview

```mermaid
graph TB
    subgraph "Entry Points"
        E1[Inside Page<br/>Page Context Mode]
        E2[Home/Global<br/>Global Mode]
    end
    
    subgraph "Page Context Flow"
        PC1[Detect Page Context] --> PC2[Interpret Intent]
        PC2 --> PC3[Draft into Current Page]
        PC3 --> PC4[Stream Markdown]
        PC4 --> PC5[Assistant Stays Open]
    end
    
    subgraph "Global Mode Flow"
        GM1[Detect Global Context] --> GM2[Ask Location & Title]
        GM2 --> GM3[Create New Page]
        GM3 --> GM4[Navigate to Page]
        GM4 --> GM5[Draft into New Page]
        GM5 --> GM6[Stream Markdown]
        GM6 --> GM7[Assistant Stays Open]
    end
    
    subgraph "Contextual AI"
        CA1[Retrieve Org Data] --> CA2[Synthesize Insights]
        CA2 --> CA3[Output Contextual Answers]
    end
    
    subgraph "Editor Integration"
        EI1[AI Drafts in Editor]
        EI2[Markdown Format]
        EI3[Streaming Enabled]
        EI4[No Code Blocks]
        EI5[Proper Spacing]
    end
    
    E1 --> PC1
    E2 --> GM1
    
    PC5 --> CA1
    GM7 --> CA1
    
    PC4 --> EI1
    GM6 --> EI1
    
    EI1 --> EI2
    EI2 --> EI3
    EI3 --> EI4
    EI4 --> EI5
    
    classDef entry fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    classDef page fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    classDef global fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef ai fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef editor fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    
    class E1,E2 entry
    class PC1,PC2,PC3,PC4,PC5 page
    class GM1,GM2,GM3,GM4,GM5,GM6,GM7 global
    class CA1,CA2,CA3 ai
    class EI1,EI2,EI3,EI4,EI5 editor
```

## Node Reference

The following nodes correspond to the specification:

1. **User opens Page** → Entry point for Page Context Mode
2. **AI invoked inside Page** → PC1: Detect Page Context
3. **Detect Page Context** → PC1
4. **Interpret intent** → PC2
5. **Clarify if needed** → Part of PC2 decision logic
6. **Draft content into current page** → PC3
7. **Stream Markdown into editor** → PC4
8. **Assistant stays open** → PC5
9. **User opens Home** → Entry point for Global Mode
10. **AI invoked from Home** → GM1: Detect Global Context
11. **Detect Global Context** → GM1
12. **Ask for location + title** → GM2
13. **Create new page** → GM3
14. **Navigate to new page** → GM4
15. **Draft content into new page** → GM5
16. **Stream Markdown into editor** → GM6
17. **Assistant stays open** → GM7
18. **Contextual AI retrieves org data** → CA1
19. **AI synthesizes insights** → CA2
20. **AI outputs contextual answers** → CA3

## Key Behaviors

### Page Context Mode
- **Default Behavior**: Draft content into the current page
- **Exception**: Only creates new page if user explicitly says "create a new page"
- **No Redirects**: Content appears in current page editor
- **Continuous Flow**: Assistant stays open for follow-ups

### Global Mode
- **Default Behavior**: Create a new page
- **Required Questions**: Location (Space/Project) and Title
- **Navigation**: System navigates to new page, but AI assistant remains open
- **Seamless Experience**: Content streams into new page immediately

### Editor Integration
- Content is drafted **inside the editor**, not in chat bubbles
- AI output is always **Markdown** (H1, H2, paragraphs, lists)
- **No code blocks** around content
- **Proper spacing** maintained
- **Streaming enabled** for typing effect
- **Never leaves page blank** after creation

### Contextual Intelligence
- AI has access to: Projects, Epics, Tasks, HRIS data, Documentation, Meeting notes, User activity, Organizational structure
- AI synthesizes data to provide grounded answers
- AI suggests actions and follow-ups
- AI behaves like a virtual COO, not a generic chatbot

                         ┌───────────────────────────────────┐
                         │               USER                │
                         │  Web app (browser / desktop)      │
                         └───────────────────────────────────┘
                                           │
                                           ▼
┌───────────────────────────────────────────────────────────────────────┐
│                     LOOPWELL FRONTEND (NEXT.JS APP)                  │
│                                                                       │
│  ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐     │
│  │     SPACES      │   │      ORG        │   │    DASHBOARD    │     │
│  │ Projects / Wiki │   │ Org chart /     │   │ Home, calendar, │     │
│  │ Tasks UI        │   │ people / roles  │   │ AI notetaker    │     │
│  └─────────────────┘   └─────────────────┘   └─────────────────┘     │
│           ▲                     ▲                      ▲             │
│           │                     │                      │             │
│           │                     │                      │             │
│                 ┌───────────────────────────────────┐                │
│                 │          LOOPBRAIN UI             │                │
│                 │  • Global LLM chat (playground)   │                │
│                 │  • Contextual assistant panel     │                │
│                 │    (available across all pages)   │                │
│                 └───────────────────────────────────┘                │
└───────────────────────────────────────────────────────────────────────┘
                                           │
                                           ▼
┌───────────────────────────────────────────────────────────────────────┐
│                          BACKEND / API LAYER                         │
│                                                                       │
│  ┌──────────────────────┐  ┌──────────────────────┐ ┌────────────────┐│
│  │  SPACES SERVICE      │  │   ORG SERVICE        │ │ DASHBOARD SVC  ││
│  │ - pages / projects   │  │ - users / roles      │ │ - calendar     ││
│  │ - tasks / statuses   │  │ - org chart          │ │ - integrations ││
│  └──────────────────────┘  └──────────────────────┘ └────────────────┘│
│           ▲                          ▲                     ▲         │
│           │                          │                     │         │
│           │                          │                     │         │
│  ┌─────────────────────┐  ┌─────────────────────┐ ┌─────────────────┐ │
│  │  SPACES AI LAYER    │  │   ORG AI LAYER      │ │ DASHBOARD AI    │ │
│  │ - keeps summaries   │  │ - role summaries    │ │ LAYER           │ │
│  │ - doc embeddings    │  │ - org patterns      │ │ - meeting notes │ │
│  │ - project status    │  │ - people context    │ │ - activity ctx  │ │
│  └─────────────────────┘  └─────────────────────┘ └─────────────────┘ │
│           ▲                          ▲                     ▲         │
│           └───────────────┬──────────┴───────────────┬─────┘         │
│                           │                          │               │
│                 ┌────────────────────────────────────────────┐       │
│                 │           LOOPBRAIN ORCHESTRATOR          │       │
│                 │                                            │       │
│                 │  Components:                               │       │
│                 │  • LLM Gateway (generic chat interface)    │       │
│                 │  • Contextual Agent Engine                 │       │
│                 │      - decides which feature AIs to query  │       │
│                 │      - merges Spaces/Org/Dashboard context │       │
│                 │      - builds prompts with org state       │       │
│                 │      - returns synthesized answer / action │       │
│                 └────────────────────────────────────────────┘       │
│                           │                          ▲               │
│                           │                          │               │
│         ┌─────────────────┴─────────────┐        ┌───┴─────────────┐ │
│         │     CONTEXT STORES            │        │  LLM PROVIDERS  │ │
│         │  (shared across features)     │        │ (GPT / Sonnet / │ │
│         │                               │        │  Gemini, etc.)  │ │
│         │ - Vector index of pages       │        └─────────────────┘ │
│         │ - Task & project summaries    │                             │
│         │ - Org / role embeddings       │                             │
│         │ - Meeting note embeddings     │                             │
│         └───────────────────────────────┘                             │
└───────────────────────────────────────────────────────────────────────┘
                                           │
                                           ▼
┌───────────────────────────────────────────────────────────────────────┐
│                   EXTERNAL APPS & INTEGRATIONS                       │
│                                                                       │
│  • Calendar (Google, Outlook)                                         │
│  • Slack / Teams / Email                                              │
│  • Meeting tools (Zoom, Meet, Teams)                                  │
│  • Payroll / HRIS connectors (read-only org data if needed)          │
└───────────────────────────────────────────────────────────────────────┘