name: Phase 3 - Production Hardening

on:
  push:
    branches: [ main, production ]
  pull_request:
    branches: [ main, production ]

jobs:
  production-safety:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run ESLint with banlist
      run: npm run lint
    
    - name: Run tests
      run: npm test
    
    - name: Check for hardcoded IDs (Safety Net)
      run: |
        echo "üîç Checking for hardcoded IDs and dev bypasses..."
        
        # Check for hardcoded workspace IDs
        if grep -r "cmgl0f0wa00038otlodbw5jhn" src/ --exclude-dir=node_modules; then
          echo "‚ùå Found hardcoded workspace ID: cmgl0f0wa00038otlodbw5jhn"
          exit 1
        fi
        
        # Check for dev user references
        if grep -r "dev-user-1" src/ --exclude-dir=node_modules; then
          echo "‚ùå Found hardcoded dev user ID: dev-user-1"
          exit 1
        fi
        
        # Check for dev@lumi.com in production code (should only be in seed scripts)
        if grep -r "dev@lumi.com" src/ --exclude-dir=node_modules --exclude="**/seed*.ts"; then
          echo "‚ùå Found dev@lumi.com in production code"
          exit 1
        fi
        
        # Check for development bypass patterns
        if grep -r "ALLOW_DEV_LOGIN.*true" src/ --exclude-dir=node_modules; then
          echo "‚ùå Found hardcoded ALLOW_DEV_LOGIN=true"
          exit 1
        fi
        
        if grep -r "PROD_LOCK.*false" src/ --exclude-dir=node_modules; then
          echo "‚ùå Found hardcoded PROD_LOCK=false"
          exit 1
        fi
        
        echo "‚úÖ No hardcoded IDs or dev bypasses found"
    
    - name: Verify environment flag usage
      run: |
        echo "üîç Verifying environment flag usage..."
        
        # Check that environment flags are used properly
        if ! grep -r "process.env.ALLOW_DEV_LOGIN" src/; then
          echo "‚ùå ALLOW_DEV_LOGIN environment flag not found in code"
          exit 1
        fi
        
        if ! grep -r "process.env.PROD_LOCK" src/; then
          echo "‚ùå PROD_LOCK environment flag not found in code"
          exit 1
        fi
        
        if ! grep -r "process.env.ENABLE_ASSISTANT" src/; then
          echo "‚ùå ENABLE_ASSISTANT environment flag not found in code"
          exit 1
        fi
        
        echo "‚úÖ Environment flags properly used"
    
    - name: Check scoping middleware coverage
      run: |
        echo "üîç Checking scoping middleware coverage..."
        
        # Verify scoping middleware is imported in db.ts
        if ! grep -q "scopingMiddleware" src/lib/db.ts; then
          echo "‚ùå Scoping middleware not imported in db.ts"
          exit 1
        fi
        
        # Verify workspace context functions exist
        if ! grep -q "setWorkspaceContext" src/lib/prisma/scopingMiddleware.ts; then
          echo "‚ùå setWorkspaceContext function not found"
          exit 1
        fi
        
        echo "‚úÖ Scoping middleware properly configured"
    
    - name: Verify auth system usage
      run: |
        echo "üîç Verifying auth system usage..."
        
        # Check that getAuthenticatedUser is used in API routes
        if ! grep -r "getAuthenticatedUser" src/app/api/ --include="*.ts"; then
          echo "‚ùå getAuthenticatedUser not found in API routes"
          exit 1
        fi
        
        # Check that assertAccess is used in API routes
        if ! grep -r "assertAccess" src/app/api/ --include="*.ts"; then
          echo "‚ùå assertAccess not found in API routes"
          exit 1
        fi
        
        echo "‚úÖ Auth system properly integrated"
    
    - name: Production deployment check
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/production'
      run: |
        echo "üöÄ Production deployment verification..."
        
        # Check that production template exists
        if [ ! -f "env.production.template" ]; then
          echo "‚ùå Production environment template not found"
          exit 1
        fi
        
        # Verify production template has correct flags
        if ! grep -q 'ALLOW_DEV_LOGIN="false"' env.production.template; then
          echo "‚ùå Production template missing ALLOW_DEV_LOGIN=false"
          exit 1
        fi
        
        if ! grep -q 'PROD_LOCK="true"' env.production.template; then
          echo "‚ùå Production template missing PROD_LOCK=true"
          exit 1
        fi
        
        echo "‚úÖ Production configuration verified"
    
    - name: Build application
      run: npm run build
    
    - name: Production readiness report
      run: |
        echo "üìä Production Readiness Report"
        echo "================================"
        echo "‚úÖ ESLint checks passed"
        echo "‚úÖ Tests passed"
        echo "‚úÖ No hardcoded IDs found"
        echo "‚úÖ Environment flags properly used"
        echo "‚úÖ Scoping middleware configured"
        echo "‚úÖ Auth system integrated"
        echo "‚úÖ Application builds successfully"
        echo ""
        echo "üöÄ Ready for production deployment!"
